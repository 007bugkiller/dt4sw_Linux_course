- [Linux线程编程初步] (#Linux线程编程初步)



# Linux线程编程初步

## 背景
* Linux间接起源于Unix，Linux最初是不存在“线程”概念
* 而 POSIX Thread标准建立，Unix引入线程，大量函数被重新，信号机制变得非常复杂
* 2005年后，处理器厂商开始向**超线程**和多核架构靠拢

> 超线程是指单个处理器可以像2个逻辑处理器一样运行，这样单个处理器可以并行执行线程

一些概念
* 物理处理器：主机上的真实处理器硬件
* 逻辑处理器：逻辑处理器和超线程相关
  * 不支持超线程，逻辑处理器数量和物理处理器一样
  * 支持超线程，逻辑处理器数量是物理处理器的2倍
* 核心数：即处理器中内核数量

## 线程和进程的关系

### 进程
应用程序的一次加载执行（系统进行资源分配的单位）

### 线程
进程中的程序执行流

* 一个进程可以有多个线程（至少一个）
* 每个线程执行不同任务（可以并行执行）
* 同一个进程的多个线程共享系统资源

![Linux线程编程初步1.png](./pic/Linux线程编程初步1.png)
![Linux线程编程初步2.png](./pic/Linux线程编程初步2.png)

### 多进程 VS 多线程

![Linux线程编程初步3.png](./pic/Linux线程编程初步3.png)

* 创建/销毁耗时：线程 < 进程 （进程创建需要申请系统资源，线程不用）
* 多线程切换开销 < 多进程切换 （进程切换需要保存资源使用情况，线程不用）
* 线程间共享数据复杂度 < 多进程共享数据复杂度 (线程间共享系统资源，而进程间是独立的)
* 多线程代码稳定性 < 多进程代码稳定性 （多线程只要有一个挂了，整个进程就挂了，而多进程是互相独立的，挂了也不影响其他进程）
* 多线程代码复杂性 > 多进程代码复杂性 （多线程涉及资源共享使用）

### Linux多线程API

```C
#include <pthread.h>

/*p
pid: 进程标识符
attr: 进程属性设置，可设置NULL 即使用默认属性
start_route: 线程入口函数
arg: 线程入口函数参数 
*/
int pthread_create(pthread_t* pid, const pthread_attr_t* attr,
                    void*(start_route)(void*), void* arg);
        
// 返回当前线程ID
pthread_t pthread_self();

// 线程等待
int pthrad_join(pthread_t thread, void** retval);
```