- [多核调度预备知识](#多核调度预备知识)
  - [进程调度的本质](#进程调度的本质)
  - [Linux的进程状态(ps au)](#linux的进程状态ps-au)
  - [细说空闲状态](#细说空闲状态)
  - [Linux的性能工具](#linux的性能工具)
    - [平均负载(load average)](#平均负载load-average)
    - [ps](#ps)
    - [top](#top)
    - [sar](#sar)
  - [系统调度核心性能指标](#系统调度核心性能指标)
    - [吞吐量](#吞吐量)
    - [延迟](#延迟)

# 多核调度预备知识

问题：内核对进程调度时发生了什么

## 进程调度的本质

* 任务切换
  * 即上下文切换
  * 上下文指寄存器的值
  * 上下文切换指
    * 将寄存器的值保存在内存中
    * 将新的任务的寄存器值拷贝到寄存器中
    * 而上下文的切换必然导致进程状态的切换
    * 上下文切换由中断触发(时间中断，IO中断。。)

![多核调度1](/pic/多核调度1.png)

问题：上下文切换时如果出现中断怎么办  
一般来说，上下文切换前会把中断关掉，防止中断打断，这种关中断的方式在执行其他的一些重要操作也会用上


## Linux的进程状态(ps au) 
![多核调度2](/pic/多核调度2.png)
![多核调度3](/pic/多核调度3.png)

## 细说空闲状态

* 处理器上电后，开始一直不停执行指令
* 当系统不存在进程后，会执行一个**不执行操作**的空闲进程
* 空闲进程的职责：执行特殊指令让处理器休眠或者进入低功耗模式
* 空闲状态一种暂态，当有新的进程出现，空闲进程就会退出

## Linux的性能工具

* ```ps```查看进程运行时状态
* ```top```Linux整体性能监测
* ```sar```Linux活动情况

### 平均负载(load average)

* 表示一段时间内进程对系统资源需求平均值(1，5，15分钟)
  * **接近0 代表系统处于空闲状态**
  * **大于1 意味着系统繁忙 任务需要等待**
    * **如果 1分钟的平均值大于 5或15分钟的平均值代表系统负载在增加**
    * **如果 1分钟的平均值小于 5或15分钟的平均值代表系统负载在减少**

### ps

可以查看运行时进程的CPU占有率，状态，内存使用等

![多核调度5](/pic/多核调度5.png)

### top

* 上面部分是总体运行状态
* 下面部分是任务列表
* 可以在运行时输入指令运行相应动作(比如可以按`k`可以杀死相应进程)
* 按 `h`可以进入帮助
  
![多核调度4](/pic/多核调度4.png)
* 比如第一行包含运行时间 用户数，1分钟，5分钟，15分钟的平均负载
* 第二行是任务状态显示
* 三四行是内存使用状态

### sar

> 这个命令一般需要自己安装，ubuntu为例，安装完后到 /etc/default/sysstat文件 把 false改为true

* 执行 `sar -q 打印间隔 打印次数`
  * `runq-sz` 执行队列长度
  * `plist-sz` 运行中进程总数 
  * `lavg-1`  1分钟的平均负载 
  * `lavg-5`  5分钟的平均负载
  * `lavg-15` 15分钟的平均负载

![多核调度6](/pic/多核调度6.png)

## 系统调度核心性能指标

### 吞吐量
  单位时间内工作总量
* 处理器资源消耗越多，吞吐量越大
* 对于进程调度而言，吞吐量指单位时间处理的进程数量

### 延迟
从开始处理任务到结束处理任务的时间

* 对于进程而言，延迟就是进程生命周期
* 注意：**执行 和 运行 不同，运行可以是长时间，但执行时间可能很短**

![吞吐量1](/pic/吞吐量1.png)
![吞吐量1](/pic/吞吐量2.png)
![吞吐量1](/pic/吞吐量3.png)
![吞吐量1](/pic/吞吐量4.png)

结论：
* 处理器的吞吐量是由硬件决定的，吞吐量存在上限
* 当吞吐量未达到上限时，进程的延迟取决于自身
* 当吞吐量达到了上限，进程数量增加，总延迟会增加，但是平均延迟不变

<font color=red>思考：如何验证处理器，吞吐量，进程数量之间的关系呢</font>